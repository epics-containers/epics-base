#!/bin/bash

# a script to locally build all targets containers for this IOC using podman

THIS_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
cd ${THIS_DIR}

export TMPDIR=/tmp
set -xe

if [[ -z ${TARGET_ARCHITECTURE} || ${TARGET_ARCHITECTURE}=="linux" ]]; then
    podman buildx build --net host --target developer --build-arg TARGETARCH=amd64 --build-arg TARGET_ARCHITECTURE=linux -t epics-base-linux-developer:local .
    podman buildx build --net host --target runtime --build-arg TARGETARCH=amd64 --build-arg TARGET_ARCHITECTURE=linux -t epics-base-linux-runtime:local .
fi

if [[ ${TARGET_ARCHITECTURE}=="rtems" ]]; then
    podman buildx build --net host --target developer --build-arg TARGETARCH=amd64 --build-arg TARGET_ARCHITECTURE=rtems -t epics-base-rtems-developer:local .
    podman buildx build --net host --target runtime --build-arg TARGETARCH=amd64 --build-arg TARGET_ARCHITECTURE=rtems -t epics-base-rtems-runtime:local .
fi
